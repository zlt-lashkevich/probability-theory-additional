#set document(title: "Лучшее пари для простаков: HTH vs THH")
#set page(paper: "a4", margin: 2cm)
#set text(lang: "ru", font: "New Computer Modern", size: 11pt)
#set par(justify: true, leading: 0.65em)
#show selector(<nonumber>): set heading(numbering: none)

#align(center)[
  #text(size: 16pt, weight: "bold")[
    Лучшее пари для простаков (метод траекторий)
  ]
  
  #text(size: 12pt)[HTH vs THH: метод траекторий]
]

#v(1em)

= Условие задачи

Правильную монетку подбрасывают бесконечное число раз. Обозначим: $H$ — орёл, $T$ — решка

Два игрока ожидают появления своих комбинаций: $quad$ Игрок $A$ ждёт последовательность $H T H$, Игрок $B$ ждёт последовательность $T H H$

*Требуется найти:*
1. $P(A "выиграет")$, $quad P(B "выиграет")$, $quad P("никто не победит")$ — вероятность бесконечной игры
2. $EE[tau]$ — математическое ожидание времени игры
3. $k$-тый начальный момент $EE[tau^k]$

= Метод траекторий (Traj)

#box(
  width: 100%,
  fill: rgb("#e8f4f8"),
  inset: 10pt,
  radius: 4pt,
)[
  *Traj* — формальная сумма всех незавершённых траекторий:
  
  $ "Traj" = 1 + (H+T) + (H+T)^2 + (H+T)^3 + ... = 1/(1 - H - T) $
  
  При подстановке $H = T = 1/2$: каждый член даёт $1$, сумма расходится.
  
  *Интерпретация:* Traj — это "мера" всех возможных путей в дереве траекторий.
]

Когда мы "требуем" появления паттерна в конце траектории, получаем уравнения с учётом перекрытий.
=== Анализ перекрытий

Рассмотрим, что происходит, когда в последовательности бросков появляется $H T H$:

#align(center)[
#box(
  width: 85%,
  fill: rgb("#f9f9f9"),
  inset: 10pt,
  radius: 4pt,
)[
```
Последовательность: ... X X H T H
                            ↑ ↑ ↑
                            1 2 3
```

После появления $H T H$ смотрим на суффиксы:
- Суффикс длины 2: $T H$ — это префикс $T H H$! (начало для $B$)
- Суффикс длины 1: $H$ — это префикс $H T H$! (начало для $A$)
]
]

Это означает: когда $A$ выигрывает (появляется $H T H$), в этот момент:
- Игрок $B$ уже имеет "задел" $T H$ для своей комбинации $T H H$
- Игрок $A$ имеет "задел" $H$ для новой попытки $H T H$

Аналогично для $T H H$:

#align(center)[
#box(
  width: 85%,
  fill: rgb("#f9f9f9"),
  inset: 10pt,
  radius: 4pt,
)[
```
Последовательность: ... X X T H H
                            ↑ ↑ ↑
                            1 2 3
```

После появления $T H H$ смотрим на суффиксы:
- Суффикс длины 2: $H H$ — НЕ префикс ни $H T H$, ни $T H H$
- Суффикс длины 1: $H$ — это префикс $H T H$! (начало для $A$)
]
]

== Уравнения через Traj
Перекрытия определяют *структуру переходов* между состояниями
== *Для паттерна $H T H$:*

$
  "Traj" dot H T H = P(A) + P(B) dot T H + P(A) dot T H
$

- $P(A)$: чистая победа $A$ (HTH появился первым)
- $P(B) dot T H$: если бы $B$ победил (THH), то суффикс $T H$ мог бы начать новый HTH
- $P(A) dot T H$: если $A$ победил с перекрытием (суффикс $T H$ от HTH)

== *Для паттерна $T H H$:*

$
  "Traj" dot T H H = P(B) + P(A) dot H + P(B) dot H
$

- Суффикс $H$ от $H T H$ может быть началом $T H H$ через цепочку
- Суффикс $H$ от $T H H$ — самоперекрытие

== Подстановка вероятностей

При $H = T = 1/2$: $quad H T H → (1/2)^3 = 1/8$, $quad T H → (1/2)^2 = 1/4$,$ quad H → 1/2$

#box(
  width: 100%,
  fill: rgb("#fff4e6"),
  inset: 10pt,
  radius: 4pt,
)[
  *Система уравнений:*
  
  $ "Traj" dot 1/8 &= P(A) + P(B) dot 1/4 + P(A) dot 1/4 \
  "Traj" dot 1/8 &= P(B) + P(A) dot 1/2 + P(B) dot 1/2 \
  1 &= P(A) + P(B) + P(emptyset)  $
]

== Доказательство: $P("никто не победит") = 0$

#box(
  width: 100%,
  fill: rgb("#e8f8e8"),
  inset: 12pt,
  radius: 4pt,
)[
  Разобьём бесконечную последовательность на непересекающиеся тройки:
  
  $ underbrace((? ? ?), "тройка 1") underbrace((? ? ?), "тройка 2") underbrace((? ? ?), "тройка 3") ... $
  
  Вероятность, что тройка — это *ни $H T H$, ни $T H H$*:
  
  $ P("тройка" (H + T)^3 и != H T H "и" != T H H) = (8 - 2)/8 = 6/8 = 3/4 $
]

== Оценка вероятности бесконечной игры

$
  P("никто не победил за" n "троек") <= (3/4)^n -> 0 "при" n -> infinity
$

#box(
  width: 90%,
  fill: rgb("#e8f4f8"),
  inset: 10pt,
  radius: 4pt,
)[
  *Вывод:*
  
  $ P("никто никогда не победит") = 0 $
  
  Следовательно: $P(A) + P(B) = 1$
]

= Диаграмма переходов

Пусть $p_s$ — вероятность победы игрока $A$, начиная из состояния $s$.

#align(center)[
#box(
  width: 100%,
  fill: rgb("#f8f8f8"),
  inset: 12pt,
  radius: 4pt,
)[
  #text(size: 9pt)[
#table(
  columns: 5,
  stroke: 0.5pt,
  inset: 6pt,
  align: center,
  fill: (col, row) => if row == 0 { rgb("#e8f4f8") },
  [*Из состояния*], [*Выпало $H$*], [*Выпало $T$*], [*Примечание*], [*Уравнение для $p_s$*],
  
  [$emptyset$], [$H$], [$T$], [Начало], [$p_emptyset = 1/2 p_H + 1/2 p_T$],
  [$H$], [$H H$], [$H T$], [], [$p_H = 1/2 p_(H H) + 1/2 p_(H T)$],
  [$T$], [$T H$], [$T T$], [], [$p_T = 1/2 p_(T H) + 1/2 p_(T T)$],
  [$H H$], [$H H$], [$H T$], [Петля на $H$], [$p_(H H) = 1/2 p_(H H) + 1/2 p_(H T)$],
  [$H T$], [#text(fill: green)[*$H T H$ ✓*]], [$T T$], [#text(fill: green)[*A выиграл!*]], [$p_(H T) = 1/2 dot 1 + 1/2 p_(T T)$],
  [$T H$], [#text(fill: red)[*$T H H$ ✗*]], [$H T$], [#text(fill: red)[*B выиграл!*]], [$p_(T H) = 1/2 dot 0 + 1/2 p_(H T)$],
  [$T T$], [$T H$], [$T T$], [Петля на $T$], [$p_(T T) = 1/2 p_(T H) + 1/2 p_(T T)$],
)
  ]
]
]

== Пошаговое решение системы

*Из $p_(T T)$:* $quad p_(T T) = 1/2 p_(T H) + 1/2 p_(T T) quad => quad p_(T T) = p_(T H)$

*Из $p_(T H)$:* $quad p_(T H) = 1/2 p_(H T)$ $quad$ *Следовательно:* $quad p_(T T) = 1/2 p_(H T)$

*Из $p_(H T)$:* 
$
  p_(H T) = 1/2 + 1/2 p_(T T) = 1/2 + 1/4 p_(H T) quad => quad 3/4 p_(H T) = 1/2 quad => quad p_(H T) = 2/3
$

*Остальные значения:*
$
  p_(T H) = 1/3, quad p_(T T) = 1/3, quad p_(H H) = p_(H T) = 2/3
$

$
  p_H = 1/2 dot 2/3 + 1/2 dot 2/3 = 2/3, quad p_T = 1/2 dot 1/3 + 1/2 dot 1/3 = 1/3 quad
  p_emptyset = 1/2 dot 2/3 + 1/2 dot 1/3 = 1/2
$

#box(
  width: 100%,
  fill: rgb("#e8f8e8"),
  inset: 15pt,
  radius: 4pt,
)[
  #align(center)[
    *Ответ (вероятности):*
    
    #table(
      columns: 3,
      stroke: 0.5pt,
      inset: 10pt,
      align: center,
      fill: (col, row) => if row == 0 { rgb("#d4edda") },
      [$P(A "выиграет с" H T H)$], [$P(B "выиграет с" T H H)$], [$P("никто не победит")$],
      [$1/2$], [$1/2$], [$0$],
    )
    
    #v(0.5em)
    *Необычное наблюдение:* Игра полностью симметрична — оба игрока выигрывают с равной вероятностью $1/2$, несмотря на разные комбинации!
  ]
]
= Математическое ожидание времени игры

== Уравнения для $E_s = EE[tau | "старт из" s]$

== Решение

Из $E_(T T) = 2 + E_(T H)$ и $E_(T H) = 1 + 1/2 E_(H T)$:
$
  E_(T T) = 3 + 1/2 E_(H T)
$

Подставляем в $E_(H T) = 1 + 1/2 E_(T T)$:
$
  E_(H T) = 1 + 1/2 (3 + 1/2 E_(H T)) = 5/2 + 1/4 E_(H T) quad => quad E_(H T) = 10/3
$

#align(center)[
#box(
  width: 100%,
  fill: rgb("#f8f8f8"),
  inset: 10pt,
  radius: 4pt,
)[
  #text(size: 9pt)[
#table(
  columns: 4,
  stroke: 0.5pt,
  inset: 6pt,
  align: center,
  fill: (col, row) => if row == 0 { rgb("#e8f4f8") },
  [*Состояние*], [*Уравнение*], [*Упрощение*], [*Значение*],
  
  [$H T$], [$E_(H T) = 1 + 1/2 dot 0 + 1/2 E_(T T)$], [$E_(H T) = 1 + 1/2 E_(T T)$], [$10/3$],
  [$T H$], [$E_(T H) = 1 + 1/2 dot 0 + 1/2 E_(H T)$], [$E_(T H) = 1 + 1/2 E_(H T)$], [$8/3$],
  [$T T$], [$E_(T T) = 1 + 1/2 E_(T H) + 1/2 E_(T T)$], [$E_(T T) = 2 + E_(T H)$], [$14/3$],
  [$H H$], [$E_(H H) = 1 + 1/2 E_(H H) + 1/2 E_(H T)$], [$E_(H H) = 2 + E_(H T)$], [$16/3$],
  [$H$], [$E_H = 1 + 1/2 E_(H H) + 1/2 E_(H T)$], [], [$16/3$],
  [$T$], [$E_T = 1 + 1/2 E_(T H) + 1/2 E_(T T)$], [], [$14/3$],
  [$emptyset$], [$E_emptyset = 1 + 1/2 E_H + 1/2 E_T$], [], [$6$],
)
  ]
]
]


#box(
  width: 100%,
  fill: rgb("#e8f4f8"),
  inset: 12pt,
  radius: 4pt,
)[
  *Математическое ожидание времени игры:*
  
  $ EE[tau] = E_emptyset = 6 "бросков" $
]

= $k$-тый начальный момент $EE[tau^k]$

== Рекуррентная формула


Для вычисления $EE[tau^k]$ из состояния $s$ обозначим $M_s^((k)) = EE[tau^k | "старт из" s]$

#box(
  width: 100%,
  fill: rgb("#fff4e6"),
  inset: 12pt,
  radius: 4pt,
)[
  *Ключевое соотношение:* Если из $s$ за один шаг переходим в $s'$, то время до конца игры равно $1 + tau_s'$:
  
  $ tau_s = 1 + tau_(s') $
  Раскрываем по формуле бинома Ньютона:
  $ tau_s^k = (1 + tau_(s'))^k = sum_(j=0)^k binom(k,j) tau_(s')^j $
  *Итоговая формула:*
  $ M_s^((k)) = sum_(j=0)^k binom(k,j) EE[tau_(s')^j] = sum_(j=0)^k binom(k,j) M_(s')^((j)) $
]

== Общее уравнение для состояния $s$

Если из $s$ с вероятностью $1/2$ переходим в $s_1$ или $s_2$:

$
  M_s^((k)) = 1/2 sum_(j=0)^k binom(k,j) M_(s_1)^((j)) + 1/2 sum_(j=0)^k binom(k,j) M_(s_2)^((j))
$

При $s_i$ = терминальное состояние: $M_(s_i)^((j)) = 0$ для всех $j >= 1$, $M_(s_i)^((0)) = 1$.

== Второй момент $EE[tau^2]$

Для $k = 2$: $quad (1 + tau')^2 = 1 + 2tau' + tau'^2$

$
  M_s^((2)) = 1/2 [1 + 2 M_(s_1)^((1)) + M_(s_1)^((2))] + 1/2 [1 + 2 M_(s_2)^((1)) + M_(s_2)^((2))]
$

*Система для второго момента:*

#text(size: 10pt)[
$
  M_(H T)^((2)) &= 1/2 [1 + 0 + 0] + 1/2 [1 + 2 E_(T T) + M_(T T)^((2))] = 1 + E_(T T) + 1/2 M_(T T)^((2)) \
  M_(T H)^((2)) &= 1/2 [1 + 0 + 0] + 1/2 [1 + 2 E_(H T) + M_(H T)^((2))] = 1 + E_(H T) + 1/2 M_(H T)^((2)) \
  M_(T T)^((2)) &= 1/2 [1 + 2 E_(T H) + M_(T H)^((2))] + 1/2 [1 + 2 E_(T T) + M_(T T)^((2))]
$
]

== Решение для второго момента

Подставляя $E_(H T) = 10/3$, $E_(T H) = 8/3$, $E_(T T) = 14/3$:

$
  M_(T H)^((2)) = 1 + 10/3 + 1/2 M_(H T)^((2)) = 13/3 + 1/2 M_(H T)^((2))
$

$
  M_(T T)^((2)) = 1 + 8/3 + 1/2 M_(T H)^((2)) + 14/3 + 1/2 M_(T T)^((2))
$

После решения системы:

#box(
  width: 100%,
  fill: rgb("#e8f8e8"),
  inset: 10pt,
  radius: 4pt,
)[
  $ M_(H T)^((2)) = 166/9, quad M_(T H)^((2)) = 160/9, quad M_(T T)^((2)) = 208/9 $
  
  $ EE[tau^2] = M_emptyset^((2)) = 50 $
  
  $ "Var"(tau) = EE[tau^2] - (EE[tau])^2 = 50 - 36 = 14 $
]

= Общая рекуррентная схема для $k$-того момента

#box(
  width: 100%,
  fill: rgb("#f0f8ff"),
  inset: 15pt,
  radius: 4pt,
)[
  *Алгоритм вычисления $M_s^((k))$:*
  
  1. Вычислить все $M_s^((j))$ для $j = 0, 1, ..., k-1$
  
  2. Для каждого состояния $s$ записать:
  $ M_s^((k)) = sum_("переходы" s -> s') P(s -> s') sum_(j=0)^k binom(k,j) M_(s')^((j)) $
  
  3. Для терминальных состояний: $M_"term"^((j)) = 0$ при $j >= 1$
  
  4. Решить линейную систему относительно $M_s^((k))$
]


#v(1em)

#box(
  width: 100%,
  fill: rgb("#fff4e6"),
  inset: 12pt,
  radius: 4pt,
)[
  *Замечание о симметрии:*
  
  В отличие от пары $H T T$ vs $T T H$ (где вероятности $5/12$ и $7/12$), пара $H T H$ vs $T H H$ даёт *равные шансы* обоим игрокам!
  
  Это связано с симметричной структурой перекрытий: суффикс $T H$ паттерна $H T H$ совпадает с префиксом $T H H$, и суффикс $H$ паттерна $T H H$ является частью $H T H$.
]